image: node:10

stages:
  - test
  - build
  - deploy
  - tag

cache:
  paths:
    - node_modules/

before_script:
  - yarn install

.deploy_tag: &deploy_tag
  script:
    - git config --global user.email "jjalouzot@eleven-labs.com"
    - git config --global user.name "Jonathan Jalouzot"
    - git remote set-url origin https://CaptainJojo:debe49d99c31a1b1079160215b4568cef48c0298@github.com/adeo/design-system--styleguide.git
    - cp -R src/styles registry
    - cp -R src/tokens registry
    - cp -R cssCompiler registry
    - cd registry
    - TAG=$(npm version $NPM_VERSION)
    - git add package.json
    - git commit -m 'build:new version of css'
    - echo ${NPM_TOKEN} > ~/.npmrc
    - npm publish --registry http://35.243.145.15
    - git push origin HEAD:master
    - git push origin --tags HEAD:master
    - "curl --request POST --url https://535e8ft89a.execute-api.eu-west-3.amazonaws.com/dev/tag --header 'content-type: application/json' --data '{\"tag_name\": \"'$TAG'\"}'"

.deploy_template: &deploy_template
  before_script:
    - echo ${GOOGLE_CLIENT_SECRET} > client-secret.json
    - gcloud auth activate-service-account --key-file client-secret.json

.build_template: &build_template
  artifacts:
    paths:
      - public
  script:
    - yarn build

build:demo:
  stage: build
  environment: demo
  <<: *build_template
  except:
    - master

build:prod:
  stage: build
  environment: prod
  <<: *build_template
  only:
    - master

test:
  stage: test
  environment: all
  script:
    - yarn test

deploy:demo:
  image: google/cloud-sdk
  stage: deploy
  environment: demo
  dependencies:
    - build:demo
  <<: *deploy_template
  script:
    - SERVICE_VERSION=$(echo ${CI_COMMIT_REF_NAME} | iconv -t ascii//TRANSLIT | sed -r s/[^a-zA-Z0-9]+//g | sed -r s/^-+\|-+$//g | tr A-Z a-z)
    - gcloud --quiet --verbosity=error app deploy app.demo.yaml --project=design-system-adeo --version=${SERVICE_VERSION} --no-promote
  except:
    - master
    - tags

deploy:prod:
  image: google/cloud-sdk
  stage: deploy
  environment: prod
  dependencies:
    - build:prod
  only:
    - master
  <<: *deploy_template
  script:
    - export DATE=` date '+%s'`
    - gcloud --quiet --verbosity=error app deploy app.yaml --project=design-system-adeo --version=$CI_COMMIT_REF_NAME$DATE --promote --stop-previous-version

deploy:tag:
  image: google/cloud-sdk
  stage: deploy
  environment: prod
  dependencies:
    - build:prod
  only:
    - tags
  <<: *deploy_template
  script:
    - SERVICE_VERSION=$(echo ${CI_COMMIT_TAG} | iconv -t ascii//TRANSLIT | sed -r s/[^a-zA-Z0-9]+//g | sed -r s/^-+\|-+$//g | tr A-Z a-z)
    - gcloud --quiet --verbosity=error app deploy app.yaml --project=design-system-adeo --version=$SERVICE_VERSION --promote --no-stop-previous-version

tag:patch:
  when: manual
  stage: tag
  variables:
    NPM_VERSION: 'patch'
  <<: *deploy_tag
  dependencies:
    - deploy:prod
  only:
    - master

tag:minor:
  when: manual
  stage: tag
  variables:
    NPM_VERSION: 'minor'
  <<: *deploy_tag
  dependencies:
    - deploy:prod
  only:
    - master

tag:major:
  when: manual
  stage: tag
  variables:
    NPM_VERSION: 'major'
  <<: *deploy_tag
  dependencies:
    - deploy:prod
  only:
    - master
